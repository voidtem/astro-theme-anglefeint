---
import type { GetStaticPaths } from 'astro';
import { getCollection, render } from 'astro:content';
import BlogPost from '../../../layouts/BlogPost.astro';
import {
	DEFAULT_LOCALE,
	SUPPORTED_LOCALES,
	type Locale,
	blogIdToSlugAnyLocale,
	isLocale,
} from '../../../i18n/config';
import { postsForLocale } from '../../../i18n/posts';

export const getStaticPaths = (async () => {
	const all = await getCollection('blog');
	return SUPPORTED_LOCALES.flatMap((locale) => {
		const localizedPosts = postsForLocale(all, locale);
		return localizedPosts.map((post) => {
			const related = localizedPosts
				.filter((p) => p.id !== post.id)
				.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
				.slice(0, 3);
			return {
				params: { lang: locale, slug: blogIdToSlugAnyLocale(post.id) },
				props: { post, related, locale },
			};
		});
	});
}) satisfies GetStaticPaths;
const { post, related, locale } = Astro.props;
const lang = (Astro.params.lang ?? locale ?? DEFAULT_LOCALE) as string;
const resolvedLocale: Locale = isLocale(lang) ? lang : DEFAULT_LOCALE;
const { Content } = await render(post);

function extractText(markdown: string): string {
	return markdown
		.replace(/```[\s\S]*?```/g, ' ')
		.replace(/`[^`]*`/g, ' ')
		.replace(/<[^>]+>/g, ' ')
		.replace(/!\[[^\]]*\]\([^)]+\)/g, ' ')
		.replace(/\[[^\]]+\]\([^)]+\)/g, ' ')
		.replace(/^#{1,6}\s+/gm, '')
		.replace(/[*_~>#-]/g, ' ')
		.replace(/\s+/g, ' ')
		.trim();
}

function countWords(markdown: string): number {
	const text = extractText(markdown);
	if (!text) return 0;
	return text.split(/\s+/).filter(Boolean).length;
}

function deriveMetrics(words: number) {
	const safeWords = Math.max(words, 1);
	return {
		readMinutes: Math.max(1, Math.ceil(safeWords / 220)),
		wordCount: words,
		tokenCount: Math.round(safeWords * 1.3),
		aiLatencyMs: Math.round(140 + Math.min(safeWords, 2800) * 0.11),
		aiConfidence: Number(
			Math.min(0.98, 0.78 + Math.log10(Math.max(safeWords, 20)) * 0.04).toFixed(2),
		),
	};
}

const computed = deriveMetrics(countWords(post.body ?? ''));
const resolvedData = {
	...post.data,
	locale: resolvedLocale,
	readMinutes: post.data.readMinutes ?? computed.readMinutes,
	wordCount: post.data.wordCount ?? computed.wordCount,
	tokenCount: post.data.tokenCount ?? computed.tokenCount,
	aiLatencyMs: post.data.aiLatencyMs ?? computed.aiLatencyMs,
	aiConfidence: post.data.aiConfidence ?? computed.aiConfidence,
};
---

<BlogPost {...resolvedData} related={related}>
	<Content />
</BlogPost>
