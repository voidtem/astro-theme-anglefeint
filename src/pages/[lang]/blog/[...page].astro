---
import type { GetStaticPaths } from 'astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import FormattedDate from '@anglefeint/astro-theme/components/FormattedDate.astro';
import CyberShell from '@anglefeint/astro-theme/layouts/shells/CyberShell.astro';
import { SITE_TITLE } from '../../../consts';
import {
	DEFAULT_LOCALE,
	SUPPORTED_LOCALES,
	type Locale,
	blogIdToSlugAnyLocale,
	isLocale,
	localePath,
} from '../../../i18n/config';
import { getMessages } from '../../../i18n/messages';
import { BLOG_PAGE_SIZE, postsForLocale } from '../../../i18n/posts';

export const getStaticPaths = (async () => {
	const all = await getCollection('blog');
	return SUPPORTED_LOCALES.flatMap((locale) => {
		const localizedPosts = postsForLocale(all, locale);
		const totalPages = Math.max(1, Math.ceil(localizedPosts.length / BLOG_PAGE_SIZE));

		return Array.from({ length: totalPages }, (_, pageIndex) => {
			const currentPage = pageIndex + 1;
			const start = pageIndex * BLOG_PAGE_SIZE;
			const data = localizedPosts.slice(start, start + BLOG_PAGE_SIZE);
			const prev =
				currentPage > 1
					? currentPage === 2
						? localePath(locale, '/blog/')
						: localePath(locale, `/blog/${currentPage - 1}`)
					: undefined;
			const next =
				currentPage < totalPages ? localePath(locale, `/blog/${currentPage + 1}`) : undefined;

			return {
				params: currentPage === 1 ? { lang: locale } : { lang: locale, page: String(currentPage) },
				props: {
					locale,
					page: {
						data,
						currentPage,
						lastPage: totalPages,
						url: { prev, next },
					},
				},
			};
		});
	});
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const locale = (Astro.props.locale ?? Astro.params.lang ?? DEFAULT_LOCALE) as Locale;
const resolvedLocale: Locale = isLocale(locale) ? locale : DEFAULT_LOCALE;
const messages = getMessages(resolvedLocale);
const posts = page.data;
const pageNums = Array.from({ length: page.lastPage }, (_, i) => i + 1);
const allPosts = await getCollection('blog');
const localeHrefs = Object.fromEntries(
	SUPPORTED_LOCALES.map((targetLocale) => {
		const totalPages = Math.max(1, Math.ceil(postsForLocale(allPosts, targetLocale).length / BLOG_PAGE_SIZE));
		const href =
			page.currentPage <= totalPages
				? page.currentPage === 1
					? localePath(targetLocale, '/blog/')
					: localePath(targetLocale, `/blog/${page.currentPage}`)
				: localePath(targetLocale, '/blog/');
		return [targetLocale, href];
	}),
) as Partial<Record<Locale, string>>;
const pageTitle =
	page.currentPage === 1
		? `${messages.blog.title} | ${SITE_TITLE}`
		: `${messages.blog.pageTitle} ${page.currentPage} | ${SITE_TITLE}`;
const pageDescription =
	page.currentPage === 1
		? messages.blog.archiveDescription
		: `${messages.blog.pageDescription} ${page.currentPage}.`;

// Blade Runner: 负 delay 让雨滴首次加载即分布全屏
const rainTypes = ['normal', 'thin', 'fog', 'skew'];
const rainDrops = Array.from({ length: 48 }, (_, i) => {
	const type = rainTypes[i % 4];
	return {
		left: `${Math.random() * 100}%`,
		delay: `${-5 + Math.random() * 6}s`,
		duration: `${3.3 + Math.random() * (type === 'thin' ? 1.1 : type === 'fog' || type === 'skew' ? 1.7 : 1.4)}s`,
		opacity: type === 'fog' ? 0.12 + Math.random() * 0.1 : 0.2 + Math.random() * 0.25,
		type,
	};
});
const dustParticles = Array.from({ length: 22 }, () => ({
	left: `${Math.random() * 100}%`,
	top: `${Math.random() * 100}%`,
	size: 4 + Math.random() * 4,
	delay: `${Math.random() * 10}s`,
	duration: `${8 + Math.random() * 12}s`,
}));
---
<CyberShell locale={resolvedLocale} title={pageTitle} description={pageDescription} localeHrefs={localeHrefs}>
	<Fragment slot="body-start">
		<div class="cyber-rain" aria-hidden="true">
			{
				rainDrops.map((drop) => (
					<div
						class={`cyber-rain-drop cyber-rain-drop--${drop.type}`}
						style={{
							left: drop.left,
							animationDelay: drop.delay,
							animationDuration: drop.duration,
							opacity: drop.opacity,
						}}
					/>
				))
			}
		</div>
		<div class="cyber-dust" aria-hidden="true">
			{dustParticles.map((p) => (
				<div
					class="cyber-dust-particle"
					style={{
						left: p.left,
						top: p.top,
						width: p.size,
						height: p.size,
						animationDelay: p.delay,
						animationDuration: p.duration,
					}}
				/>
			))}
		</div>
	</Fragment>
	<section>
		<ul>
			{
				posts.map((post) => (
					<li>
						<a href={localePath(resolvedLocale, `/blog/${blogIdToSlugAnyLocale(post.id)}`)}>
							{post.data.heroImage && (
								<div class="img-wrapper">
									<Image width={720} height={360} src={post.data.heroImage} alt={post.data.title} />
								</div>
							)}
							<h4 class="title">{post.data.title}</h4>
							<p class="date">
								<FormattedDate date={post.data.pubDate} locale={resolvedLocale} />
							</p>
						</a>
					</li>
				))
			}
		</ul>
	</section>
	{page.lastPage > 1 && (
		<nav class="pagination" aria-label="Pagination">
			{page.url.prev && <a href={page.url.prev}>{messages.blog.previous}</a>}
			{pageNums.map((num) => (
				<a
					href={num === 1 ? localePath(resolvedLocale, '/blog/') : localePath(resolvedLocale, `/blog/${num}`)}
					class={num === page.currentPage ? 'current' : undefined}
					aria-current={num === page.currentPage ? 'page' : undefined}
				>
					{num}
				</a>
			))}
			{page.url.next && <a href={page.url.next}>{messages.blog.next}</a>}
		</nav>
	)}
</CyberShell>
