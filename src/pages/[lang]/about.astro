---
import type { GetStaticPaths } from 'astro';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { getCollection } from 'astro:content';
import { ABOUT_CONFIG } from '../../config/about';
import { THEME } from '../../config/theme';
import {
	DEFAULT_LOCALE,
	SUPPORTED_LOCALES,
	type Locale,
	blogIdToSlugAnyLocale,
	isLocale,
	localePath,
} from '../../i18n/config';
import { getMessages } from '../../i18n/messages';
import { postsForLocale } from '../../i18n/posts';

export const getStaticPaths = (async () =>
	THEME.ENABLE_ABOUT_PAGE
		? SUPPORTED_LOCALES.map((lang) => ({
				params: { lang },
			}))
		: []) satisfies GetStaticPaths;

const langParam = Astro.params.lang ?? DEFAULT_LOCALE;
const locale: Locale = isLocale(langParam) ? langParam : DEFAULT_LOCALE;
const messages = getMessages(locale);

const pageTitle = messages.about.title;
const pageDescription = messages.about.description;
const allPosts = await getCollection('blog');
const blogPosts = postsForLocale(allPosts, locale)
	.map((p) => ({ slug: blogIdToSlugAnyLocale(p.id), title: p.data.title ?? p.id }));

const scriptsFoldersHtml = blogPosts
	.map(
		(p) =>
			`<a href="${localePath(locale, `/blog/${p.slug}`)}" class="term-script-folder"><svg class="term-script-folder-icon" viewBox="0 0 24 20" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4h8l2 2h10v12H2V4z"/></svg><span class="term-script-folder-label">${String(p.title).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;')}</span></a>`
	)
	.join('');

const escapeHtml = (value: string): string =>
	value
		.replace(/&/g, '&amp;')
		.replace(/</g, '&lt;')
		.replace(/>/g, '&gt;')
		.replace(/"/g, '&quot;');

const aiBody = `<pre>${ABOUT_CONFIG.modals.ai.lines.map(escapeHtml).join('\n')}</pre>`;
const decryptorBody = `<pre class="term-decryptor-pre">${escapeHtml(ABOUT_CONFIG.modals.decryptor.header)}

<span id="dec-keys">[00:00:01] 0 ${escapeHtml(ABOUT_CONFIG.modals.decryptor.keysLabel)}</span>

${escapeHtml(ABOUT_CONFIG.modals.decryptor.currentPassphraseLabel)} <span id="dec-pass">********</span>

${escapeHtml(ABOUT_CONFIG.modals.decryptor.masterKeyLabel)}
<span id="dec-master1"></span>
<span id="dec-master2"></span>

${escapeHtml(ABOUT_CONFIG.modals.decryptor.transientKeyLabel)}
<span id="dec-trans1"></span>
<span id="dec-trans2"></span>
<span id="dec-trans3"></span>
<span id="dec-trans4"></span></pre>`;

const aboutRuntimeConfig = {
	effects: ABOUT_CONFIG.effects,
	keyboard: ABOUT_CONFIG.modals.help,
	decryptorKeysLabel: ABOUT_CONFIG.modals.decryptor.keysLabel,
	modalContent: {
		'dl-data': {
			title: ABOUT_CONFIG.modals.dlData.title,
			body: `<div class="term-modal-download"><div class="modal-subtitle">${escapeHtml(ABOUT_CONFIG.modals.dlData.subtitle)}</div><div class="term-modal-progress" id="dl-progress"></div></div>`,
			type: 'progress',
		},
		ai: {
			title: ABOUT_CONFIG.modals.ai.title,
			body: aiBody,
			type: 'plain',
		},
		decryptor: {
			title: ABOUT_CONFIG.modals.decryptor.title,
			body: decryptorBody,
			type: 'decryptor',
		},
		help: {
			title: ABOUT_CONFIG.modals.help.title,
			body: '',
			type: 'keyboard',
		},
		'all-scripts': {
			title: ABOUT_CONFIG.modals.allScripts.title,
			body: '',
			type: 'scripts',
		},
	},
};
const aboutRuntimeConfigJson = JSON.stringify(aboutRuntimeConfig).replace(/</g, '\\u003c');
---

<html lang={locale}>
	<head>
		<BaseHead title={pageTitle} description={pageDescription} />
		<link rel="stylesheet" href="/styles/about-page.css" />
	</head>

	<body class="term-page about-page">
		<div class="term-bg" aria-hidden="true">
			<canvas class="term-bg-canvas"></canvas>
			<div class="term-scanlines"></div>
			<div class="term-vignette"></div>
			<div class="term-flicker"></div>
			<div class="term-glow"></div>
		</div>
		<Header
			locale={locale}
			labels={{
				home: messages.nav.home,
				blog: messages.nav.blog,
				about: messages.nav.about,
				status: messages.nav.status,
				language: messages.langLabel,
			}}
		/>
		<div class="term-progress" aria-hidden="true"></div>
		<button type="button" class="term-back-to-top" aria-label="Back to top" title="Back to top">â†‘</button>
		<div class="term-toast" aria-live="polite" aria-atomic="true"></div>
		<div class="term-mouse-glow" aria-hidden="true"></div>
		<nav class="term-sidebar" aria-label="Quick access">
			<button type="button" class="term-folder" data-modal="dl-data" aria-label={ABOUT_CONFIG.sidebar.dlData}>
				<svg class="term-folder-icon" viewBox="0 0 24 20" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M2 4h8l2 2h10v12H2V4z" />
				</svg>
				<span>{ABOUT_CONFIG.sidebar.dlData}</span>
			</button>
			<button type="button" class="term-folder" data-modal="ai" aria-label={ABOUT_CONFIG.sidebar.ai}>
				<svg class="term-folder-icon" viewBox="0 0 24 20" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M2 4h8l2 2h10v12H2V4z" />
				</svg>
				<span>{ABOUT_CONFIG.sidebar.ai}</span>
			</button>
			<button type="button" class="term-folder" data-modal="decryptor" aria-label={ABOUT_CONFIG.sidebar.decryptor}>
				<svg class="term-folder-icon" viewBox="0 0 24 20" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M2 4h8l2 2h10v12H2V4z" />
				</svg>
				<span>{ABOUT_CONFIG.sidebar.decryptor}</span>
			</button>
			<button type="button" class="term-folder" data-modal="help" aria-label={ABOUT_CONFIG.sidebar.help}>
				<svg class="term-folder-icon" viewBox="0 0 24 20" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M2 4h8l2 2h10v12H2V4z" />
				</svg>
				<span>{ABOUT_CONFIG.sidebar.help}</span>
			</button>
			<button type="button" class="term-folder" data-modal="all-scripts" aria-label={ABOUT_CONFIG.sidebar.allScripts}>
				<svg class="term-folder-icon" viewBox="0 0 24 20" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M2 4h8l2 2h10v12H2V4z" />
				</svg>
				<span>{ABOUT_CONFIG.sidebar.allScripts}</span>
			</button>
		</nav>
		<template id="term-scripts-folders-tpl">
			<div class="term-modal-scripts">
				<div class="term-modal-scripts-path">{ABOUT_CONFIG.scriptsPath}</div>
				<div class="term-modal-scripts-grid" set:html={scriptsFoldersHtml}></div>
			</div>
		</template>
		<div class="term-modal-overlay" id="term-modal" aria-hidden="true">
			<div class="term-modal" role="dialog" aria-modal="true" aria-labelledby="term-modal-title">
				<div class="term-modal-header">
					<div class="term-modal-dots" aria-hidden="true">
						<span></span><span></span><span></span>
					</div>
					<span class="term-modal-title" id="term-modal-title">Output</span>
					<button type="button" class="term-modal-close" aria-label="Close">
						<svg class="term-modal-close-icon" viewBox="0 0 24 24" width="32" height="32" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
							<path d="M6 6l12 12M18 6L6 18" />
						</svg>
					</button>
				</div>
				<div class="term-modal-body" id="term-modal-body"></div>
			</div>
		</div>
		<main class="term-content">
			<div class="term-load-scan" aria-hidden="true"></div>
			<article class="about-shell">
				<div class="prose">
					<div class="title about-title">
						<div class="term-meta">{ABOUT_CONFIG.metaLine}</div>
						<h1>{messages.about.title}</h1>
						<hr />
						<div class="term-title-bar" aria-hidden="true"></div>
					</div>

					<div class="term-response">
						<div class="term-response-header">
							<div class="term-window-dots" aria-hidden="true">
								<span></span><span></span><span></span>
							</div>
							<span class="term-response-label">Output</span>
						</div>
						<div class="term-body">
							<h2 class="about-section-title">01 / {messages.about.who}</h2>
							<p>{ABOUT_CONFIG.sections.who}</p>

							<h2 class="about-section-title">02 / {messages.about.what}</h2>
							<p>{ABOUT_CONFIG.sections.what}</p>

							<h2 class="about-section-title">03 / {messages.about.ethos}</h2>
							<div class="about-manifest">
								<ul>
									{ABOUT_CONFIG.sections.ethos.map((item) => <li>{item}</li>)}
								</ul>
							</div>

							<h2 class="about-section-title">04 / {messages.about.now}</h2>
							<p>{ABOUT_CONFIG.sections.now}</p>

							<h2 class="about-section-title">05 / {messages.about.contact}</h2>
							<p>
								{ABOUT_CONFIG.sections.contactLead} Reach me via <a href={`mailto:${ABOUT_CONFIG.contact.email}`}>email</a> or connect on
								<a href={ABOUT_CONFIG.contact.githubUrl} target="_blank" rel="noopener noreferrer">{ABOUT_CONFIG.contact.githubLabel}</a>.
							</p>

							<blockquote class="about-signature">{ABOUT_CONFIG.sections.signature}</blockquote>
							<span class="term-cursor" aria-hidden="true"></span>
						</div>
					</div>
					<button type="button" class="term-regenerate" aria-label={messages.about.regenerate}>{messages.about.regenerate}</button>
				</div>
			</article>
		</main>
		<Footer tagline={messages.footer.tagline} />
			<script is:inline id="term-runtime-config" type="application/json" set:html={aboutRuntimeConfigJson}></script>
			<script is:inline src="/scripts/about-effects.js" defer></script>
		</body>
	</html>
